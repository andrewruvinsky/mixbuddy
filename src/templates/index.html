<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MixBuddy - Song Library</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #2e2e2e;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: bold;
        }
        
        .search-container {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            background-color: #3a3a3a;
            color: white;
            outline: none;
        }
        
        .search-input::placeholder {
            color: #aaa;
        }
        
        .currently-playing {
            background-color: #3a3a3a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .currently-playing.active {
            display: block;
        }
        
        .currently-playing h2 {
            font-size: 16px;
            color: #aaa;
            margin-bottom: 10px;
        }
        
        .currently-playing-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }
        
        .current-song-name {
            font-size: 18px;
            font-weight: bold;
            flex-grow: 1;
        }
        
        .current-song-details {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-grow: 1;
        }
        
        .current-song-metadata {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .recommendation-btn {
            background-color: #5a5a5a;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        
        .recommendation-btn:hover {
            background-color: #6a6a6a;
        }
        
        .recommendation-btn:active {
            background-color: #4a4a4a;
        }
        
        .search-results {
            background-color: #2a3a4a;
            border-radius: 8px;
            padding: 10px;
            max-height: 60vh;
            overflow-y: auto;
            margin-bottom: 20px;
            display: none;
            border: 2px solid #3a4a5a;
        }
        
        .search-results.active {
            display: block;
        }
        
        .search-results-header {
            font-size: 14px;
            color: #aaa;
            padding: 10px 15px;
            margin-bottom: 5px;
        }
        
        .search-results .song-item {
            background-color: #3a4a5a;
        }
        
        .search-results .song-item:hover {
            background-color: #4a5a6a;
        }
        
        .search-results .song-item.selected {
            background-color: #2a5a5a;
        }
        
        .search-results .song-item.selected:hover {
            background-color: #357a7a;
        }
        
        .recommendations {
            background-color: #3a3a3a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .recommendations.active {
            display: block;
        }
        
        .recommendations h2 {
            font-size: 16px;
            color: #aaa;
            margin-bottom: 15px;
        }
        
        .recommendation-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            background-color: #4a4a4a;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        
        .recommendation-item:hover {
            background-color: #555555;
        }
        
        .recommendation-rank {
            font-size: 18px;
            font-weight: bold;
            color: #ffd700;
            min-width: 35px;
            margin-right: 15px;
        }
        
        .browse-section {
            margin-bottom: 20px;
        }
        
        .toggle-list-btn {
            background-color: #3a3a3a;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .toggle-list-btn:hover {
            background-color: #4a4a4a;
        }
        
        .toggle-arrow {
            transition: transform 0.3s;
        }
        
        .toggle-arrow.expanded {
            transform: rotate(180deg);
        }
        
        .song-list {
            background-color: #3a3a3a;
            border-radius: 8px;
            padding: 10px;
            max-height: 60vh;
            overflow-y: auto;
            margin-top: 10px;
            display: none;
        }
        
        .song-list.expanded {
            display: block;
        }
        
        .song-item {
            display: flex;
            align-items: center;
            background-color: #4a4a4a;
            margin: 5px 0;
            padding: 12px 15px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        
        .song-item:hover {
            background-color: #555555;
        }
        
        .song-item.selected {
            background-color: #2a5a2a;
        }
        
        .song-item.selected:hover {
            background-color: #357a35;
        }
        
        .play-btn,
        .add-btn {
            background-color: #5a5a5a;
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        
        .play-btn:hover,
        .add-btn:hover {
            background-color: #6a6a6a;
        }
        
        .play-btn:active,
        .add-btn:active {
            background-color: #4a4a4a;
        }
        
        .song-name {
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 15px;
        }
        
        .song-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
            overflow: hidden;
        }
        
        .camelot-key {
            font-size: 12px;
            font-weight: bold;
            padding: 4px 10px;
            border-radius: 4px;
            margin-right: 10px;
            flex-shrink: 0;
            min-width: 35px;
            text-align: center;
        }
        
        .tempo {
            font-size: 13px;
            font-weight: 600;
            color: #e0e0e0;
            background-color: #4a4a4a;
            padding: 4px 10px;
            border-radius: 4px;
            margin-right: 10px;
            flex-shrink: 0;
            min-width: 60px;
            text-align: center;
        }
        
        /* Rainbow colors for Camelot keys */
        .camelot-1A, .camelot-1B { background-color: #ff0000; color: white; } /* Red */
        .camelot-2A, .camelot-2B { background-color: #ff4500; color: white; } /* Orange-Red */
        .camelot-3A, .camelot-3B { background-color: #ff8c00; color: white; } /* Dark Orange */
        .camelot-4A, .camelot-4B { background-color: #ffd700; color: black; } /* Gold */
        .camelot-5A, .camelot-5B { background-color: #adff2f; color: black; } /* Green-Yellow */
        .camelot-6A, .camelot-6B { background-color: #00ff00; color: black; } /* Lime */
        .camelot-7A, .camelot-7B { background-color: #00fa9a; color: black; } /* Medium Spring Green */
        .camelot-8A, .camelot-8B { background-color: #00ffff; color: black; } /* Cyan */
        .camelot-9A, .camelot-9B { background-color: #1e90ff; color: white; } /* Dodger Blue */
        .camelot-10A, .camelot-10B { background-color: #0000ff; color: white; } /* Blue */
        .camelot-11A, .camelot-11B { background-color: #8a2be2; color: white; } /* Blue Violet */
        .camelot-12A, .camelot-12B { background-color: #ff00ff; color: white; } /* Magenta */
        
        .no-songs {
            text-align: center;
            padding: 40px;
            color: #aaa;
            font-size: 16px;
        }
        
        /* Scrollbar styling */
        .song-list::-webkit-scrollbar,
        .search-results::-webkit-scrollbar {
            width: 8px;
        }
        
        .song-list::-webkit-scrollbar-track,
        .search-results::-webkit-scrollbar-track {
            background: #3a3a3a;
        }
        
        .song-list::-webkit-scrollbar-thumb,
        .search-results::-webkit-scrollbar-thumb {
            background: #5a5a5a;
            border-radius: 4px;
        }
        
        .song-list::-webkit-scrollbar-thumb:hover,
        .search-results::-webkit-scrollbar-thumb:hover {
            background: #6a6a6a;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MixBuddy</h1>
        
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Search for a song...">
        </div>
        
        <div class="currently-playing" id="currentlyPlaying">
            <h2>Currently Playing</h2>
            <div class="currently-playing-info">
                <button class="play-btn" onclick="removeSong()" style="background: #c44;">-</button>
                <div class="current-song-details">
                    <div class="current-song-name" id="currentSongName"></div>
                    <div class="current-song-metadata">
                        <span class="camelot-key" id="currentCamelotKey" style="display: none;"></span>
                        <span class="tempo" id="currentTempo" style="display: none;"></span>
                    </div>
                </div>
                <button class="recommendation-btn" onclick="getMixRecommendations()">Get Mix Recommendations</button>
            </div>
        </div>
        
        <div class="search-results" id="searchResults">
            <div class="search-results-header" id="searchResultsHeader"></div>
        </div>
        
        <div class="recommendations" id="recommendations">
            <h2>Mix Recommendations</h2>
            <div id="recommendationsList"></div>
        </div>
        
        <div class="browse-section">
            <button class="toggle-list-btn" onclick="toggleSongList()">
                <span>Browse All Songs</span>
                <span class="toggle-arrow" id="toggleArrow">▼</span>
            </button>
            <div class="song-list" id="songList">
            {% if songs %}
                {% for song in songs %}
                <div class="song-item" data-song="{{ song }}" data-tempo="{{ song_data.get(song, {}).get('tempo', '') }}" data-camelot="{{ song_data.get(song, {}).get('camelot_key', '') }}">
                    <button class="play-btn" onclick="togglePlay(event, '{{ song }}', this)">▶</button>
                    <button class="add-btn" onclick="selectSong('{{ song }}', this.parentElement)">+</button>
                    <div class="song-info">
                        {% if song_data.get(song, {}).get('camelot_key') %}
                        <span class="camelot-key camelot-{{ song_data.get(song, {}).get('camelot_key', '').replace(' ', '') }}">{{ song_data.get(song, {}).get('camelot_key', '') }}</span>
                        {% endif %}
                        {% if song_data.get(song, {}).get('tempo') %}
                        <span class="tempo">{{ song_data.get(song, {}).get('tempo', '') }} BPM</span>
                        {% endif %}
                        <div class="song-name">{{ song.rsplit('.', 1)[0] }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-songs">No songs found in songs folder</div>
            {% endif %}
            </div>
        </div>
    </div>
    
    <audio id="audioPlayer" style="display: none;"></audio>
    
    <script>
        const audioPlayer = document.getElementById('audioPlayer');
        const searchInput = document.getElementById('searchInput');
        const songList = document.getElementById('songList');
        const searchResults = document.getElementById('searchResults');
        const searchResultsHeader = document.getElementById('searchResultsHeader');
        const currentlyPlaying = document.getElementById('currentlyPlaying');
        const currentSongName = document.getElementById('currentSongName');
        const currentCamelotKey = document.getElementById('currentCamelotKey');
        const currentTempo = document.getElementById('currentTempo');
        const recommendationsSection = document.getElementById('recommendations');
        const recommendationsList = document.getElementById('recommendationsList');
        
        let currentButton = null;
        let currentSong = null;
        let selectedSong = null;
        let selectedSongElement = null;
        let selectedAddButton = null;
        
        // Helper function to remove file extension
        function removeExtension(filename) {
            const lastDotIndex = filename.lastIndexOf('.');
            if (lastDotIndex > 0) {
                return filename.substring(0, lastDotIndex);
            }
            return filename;
        }
        
        // Store all songs for search
        const allSongs = Array.from(songList.querySelectorAll('.song-item')).map(item => ({
            element: item,
            name: item.getAttribute('data-song'),
            tempo: item.getAttribute('data-tempo'),
            camelot: item.getAttribute('data-camelot')
        }));
        
        function togglePlay(event, songName, button) {
            event.stopPropagation();
            
            if (currentSong === songName && !audioPlayer.paused) {
                // Pause current song
                audioPlayer.pause();
                button.textContent = '▶';
            } else {
                // Stop previous song if any
                if (currentButton && currentButton !== button) {
                    currentButton.textContent = '▶';
                }
                audioPlayer.pause();
                
                // Play new song
                audioPlayer.src = '/play/' + encodeURIComponent(songName);
                audioPlayer.play();
                button.textContent = '⏸';
                currentButton = button;
                currentSong = songName;
            }
        }
        
        function selectSong(songName, element) {
            // Get the add button
            const addBtn = element.querySelector('.add-btn');
            
            // If button is already a checkmark, do nothing
            if (addBtn && addBtn.textContent === '✓') {
                return;
            }
            
            // Remove previous selection
            if (selectedSongElement) {
                selectedSongElement.classList.remove('selected');
                if (selectedAddButton) {
                    selectedAddButton.textContent = '+';
                }
            }
            
            // Set new selection
            selectedSong = songName;
            selectedSongElement = element;
            element.classList.add('selected');
            
            // Update the add button to checkmark
            if (addBtn) {
                addBtn.textContent = '✓';
                selectedAddButton = addBtn;
            }
            
            // Get song metadata
            const tempo = element.getAttribute('data-tempo');
            const camelot = element.getAttribute('data-camelot');
            
            // Update currently playing section (remove extension from display)
            currentSongName.textContent = removeExtension(songName);
            
            // Update key and tempo if available
            if (camelot) {
                currentCamelotKey.textContent = camelot;
                currentCamelotKey.className = 'camelot-key camelot-' + camelot.replace(' ', '');
                currentCamelotKey.style.display = '';
            } else {
                currentCamelotKey.style.display = 'none';
            }
            
            if (tempo) {
                currentTempo.textContent = tempo + ' BPM';
                currentTempo.style.display = '';
            } else {
                currentTempo.style.display = 'none';
            }
            
            currentlyPlaying.classList.add('active');
        }
        
        function removeSong() {
            // Remove selection
            if (selectedSongElement) {
                selectedSongElement.classList.remove('selected');
                if (selectedAddButton) {
                    selectedAddButton.textContent = '+';
                }
            }
            
            // Clear selection and hide currently playing
            selectedSong = null;
            selectedSongElement = null;
            selectedAddButton = null;
            currentCamelotKey.style.display = 'none';
            currentTempo.style.display = 'none';
            currentlyPlaying.classList.remove('active');
            
            // Hide recommendations
            recommendationsSection.classList.remove('active');
        }
        
        function getMixRecommendations() {
            if (!selectedSong) {
                console.log('No song selected');
                return;
            }
            
            // Fetch recommendations from the API
            fetch('/api/recommendations?song=' + encodeURIComponent(selectedSong))
                .then(response => response.json())
                .then(data => {
                    if (data.recommendations && data.recommendations.length > 0) {
                        displayRecommendations(data.recommendations);
                    } else {
                        recommendationsList.innerHTML = '<div style="color: #aaa; padding: 10px;">No recommendations found</div>';
                        recommendationsSection.classList.add('active');
                    }
                })
                .catch(error => {
                    console.error('Error fetching recommendations:', error);
                    recommendationsList.innerHTML = '<div style="color: #c44; padding: 10px;">Error loading recommendations</div>';
                });
        }
        
        function displayRecommendations(recommendations) {
            recommendationsList.innerHTML = '';
            
            recommendations.forEach((rec, index) => {
                const rank = index + 1;
                const item = document.createElement('div');
                item.className = 'recommendation-item';
                item.setAttribute('data-song', rec.filename);
                item.setAttribute('data-tempo', rec.tempo);
                item.setAttribute('data-camelot', rec.camelot_key);
                
                // Create rank number
                const rankEl = document.createElement('div');
                rankEl.className = 'recommendation-rank';
                rankEl.textContent = rank + '.';
                
                // Create play button
                const playBtn = document.createElement('button');
                playBtn.className = 'play-btn';
                playBtn.textContent = '▶';
                playBtn.onclick = function(event) { togglePlay(event, rec.filename, this); };
                
                // Create add button
                const addBtn = document.createElement('button');
                addBtn.className = 'add-btn';
                addBtn.textContent = '+';
                addBtn.onclick = function() { selectSong(rec.filename, item); };
                
                // Create song info container
                const songInfo = document.createElement('div');
                songInfo.className = 'song-info';
                
                // Add Camelot key
                if (rec.camelot_key) {
                    const keyEl = document.createElement('span');
                    keyEl.className = 'camelot-key camelot-' + rec.camelot_key.replace(' ', '');
                    keyEl.textContent = rec.camelot_key;
                    songInfo.appendChild(keyEl);
                }
                
                // Add tempo
                if (rec.tempo) {
                    const tempoEl = document.createElement('span');
                    tempoEl.className = 'tempo';
                    tempoEl.textContent = rec.tempo + ' BPM';
                    songInfo.appendChild(tempoEl);
                }
                
                // Add song name (without extension)
                const nameEl = document.createElement('div');
                nameEl.className = 'song-name';
                nameEl.textContent = removeExtension(rec.filename);
                songInfo.appendChild(nameEl);
                
                // Assemble the item
                item.appendChild(rankEl);
                item.appendChild(playBtn);
                item.appendChild(addBtn);
                item.appendChild(songInfo);
                
                recommendationsList.appendChild(item);
            });
            
            // Show recommendations section
            recommendationsSection.classList.add('active');
        }
        
        function toggleSongList() {
            const songList = document.getElementById('songList');
            const toggleArrow = document.getElementById('toggleArrow');
            
            songList.classList.toggle('expanded');
            toggleArrow.classList.toggle('expanded');
        }
        
        // Search functionality
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                // Hide search results when search is empty
                searchResults.classList.remove('active');
                searchResults.innerHTML = '<div class="search-results-header" id="searchResultsHeader"></div>';
                return;
            }
            
            // Filter songs based on search term
            const matches = allSongs.filter(song => 
                song.name.toLowerCase().includes(searchTerm)
            );
            
            if (matches.length > 0) {
                // Show search results
                searchResults.classList.add('active');
                searchResultsHeader.textContent = `${matches.length} result${matches.length !== 1 ? 's' : ''} found`;
                
                // Clear and populate search results
                searchResults.innerHTML = '<div class="search-results-header">' + searchResultsHeader.textContent + '</div>';
                
                matches.forEach(song => {
                    const clone = song.element.cloneNode(true);
                    // Update onclick to work with cloned element
                    const playBtn = clone.querySelector('.play-btn');
                    playBtn.onclick = function(event) { togglePlay(event, song.name, this); };
                    const addBtn = clone.querySelector('.add-btn');
                    addBtn.onclick = function() { selectSong(song.name, this.parentElement); };
                    searchResults.appendChild(clone);
                });
            } else {
                // Show "no results" message
                searchResults.classList.add('active');
                searchResults.innerHTML = '<div class="search-results-header">No results found</div>';
            }
        });
        
        // Reset button when audio ends
        audioPlayer.addEventListener('ended', function() {
            if (currentButton) {
                currentButton.textContent = '▶';
                currentButton = null;
                currentSong = null;
            }
        });
        
        // Handle errors
        audioPlayer.addEventListener('error', function() {
            console.error('Error playing audio');
            if (currentButton) {
                currentButton.textContent = '▶';
            }
        });
    </script>
</body>
</html>
